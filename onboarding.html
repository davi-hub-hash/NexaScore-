                <script type="module">
    import { auth, db } from './firebase-config.js';
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let config = { country: '', currency: '', name: '' };
    let currentUser = null;

    // Verifica se o usuário está logado
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
        } else {
            // Se não estiver logado, manda para o registro
            window.location.href = "registro.html";
        }
    });

    window.selectCountry = function(code, symbol, name) {
        config.country = code;
        config.currency = symbol;
        config.name = name;
        
        document.querySelectorAll('.country-card').forEach(c => c.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        const docLabel = document.getElementById('doc-label');
        if(code === 'US') docLabel.innerText = "EIN (Employer Identification Number)";
        else if(code === 'EU') docLabel.innerText = "VAT Number";
        else docLabel.innerText = "CNPJ";
    }

    window.nextStep = function(step) {
        if(!config.country) return alert("Selecione um país primeiro.");
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
    }

    window.finishOnboarding = async function() {
        const taxId = document.getElementById('tax-id').value;
        const sector = document.getElementById('sector').value;

        if(!taxId) return alert("Preencha a identificação fiscal.");

        try {
            // SALVANDO NO FIREBASE (NexaEngine em ação)
            await setDoc(doc(db, "empresas", currentUser.uid), {
                pais: config.name,
                moeda: config.currency,
                identificacaoFiscal: taxId,
                setor: sector,
                configurado: true,
                dataConfig: new Date()
            });

            alert("Configuração Global salva com sucesso!");
            window.location.href = "dashboard.html";
        } catch (e) {
            console.error("Erro ao salvar: ", e);
            alert("Erro ao salvar configuração.");
        }
    }
                </script>
